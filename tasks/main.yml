---
# tasks file for pi_install_cgminer
- name: check cgminer exists
  stat:
    path: /usr/local/bin/cgminer
  register: cgminer_check
- include: Debian.yml
  when: ansible_os_family == 'Debian'
- include: RedHat.yml
  when: ansible_os_family == 'RedHat'
- name: clone vthoang/cgminer
  git:
    repo: https://github.com/vthoang/cgminer.git
    dest: /usr/local/src/cgminer
    clone: yes
    update: yes
    recursive: yes
    version: "{{ cgminer_git_version }}"
  register: cgminer_repo
  retries: 3
  delay: 10
  until: not cgminer_repo.failed
- name: set user as owner of cgminer folder
  file:
    path: /usr/local/src/cgminer
    owner: "{{ ansible_user }}"
    recurse: true
- include: compile_cgminer.yml
  when: not cgminer_check.stat.exists or cgminer_repo.before != cgminer_repo.after
- name: create cgminer systemctl service
  template:
    src: cgminer.service.ini
    dest: /lib/systemd/system/cgminer.service
    mode: 0755
  notify:
    - reload systemd
    - restart cgminer
- name: install cgminer template
  template:
    src: cgminer.conf.ini
    dest: /etc/cgminer.conf
    mode: 0755
  register: cgminer_template_update
  notify:
    - restart cgminer
- name: autostart cgminer
  systemd:
    name: cgminer.service
    enabled: "{{ cgminer_autostart }}"